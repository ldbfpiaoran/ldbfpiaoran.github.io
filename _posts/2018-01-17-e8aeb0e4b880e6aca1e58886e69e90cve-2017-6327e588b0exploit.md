---
id: 192
title: 记一次分析CVE-2017-6327到exploit
date: 2018-01-17T21:30:14+00:00
author: bfpiaoran
layout: post
categories:
  - 未分类
---
前些天买了shodan的会员玩的特别开心，直到某一天看到了这个东西。  
<img class="alignnone size-full wp-image-193" src="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-2.png" alt="" width="554" height="298" srcset="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-2.png 554w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-2-300x161.png 300w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-2-230x124.png 230w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-2-350x188.png 350w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-2-480x258.png 480w" sizes="(max-width: 554px) 85vw, 554px" />  
这是什么？在百度一查原来是一个邮件系统的中间件叫电子邮件网关系统，说白了就是过滤邮件的，那么他的重要性可想而知了，所有的邮件都从这台服务器进出。  
Seebug上搜索  
<img class="alignnone size-full wp-image-194" src="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-3.png" alt="" width="554" height="206" srcset="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-3.png 554w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-3-300x112.png 300w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-3-550x206.png 550w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-3-230x86.png 230w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-3-350x130.png 350w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-3-480x178.png 480w" sizes="(max-width: 554px) 85vw, 554px" />  
基本上没什么漏洞不过17年有一个远程命令执行 还有个任意文件读取  
<img class="alignnone size-full wp-image-195" src="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-4.png" alt="" width="554" height="346" srcset="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-4.png 554w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-4-300x187.png 300w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-4-230x144.png 230w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-4-350x219.png 350w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-4-480x300.png 480w" sizes="(max-width: 554px) 85vw, 554px" />  
不过权限很低，只能看到网关里面的账户下的，而且从官方试用的镜像来看，官方给的账户是一个权限极低的账户。

那么只能从命令执行下手了。  
官方文档说利用了两个漏洞，先看第一个漏洞  
第一个漏洞会存在一个未授权访问  
通过向/brightmail/action1.do?method=method\_name发出GET请求，如果method\_name是公共方法，则可以执行LoginAction.method_name。  
存在一个notificationLogin方法 该方法存在缺陷。  
<img class="alignnone size-full wp-image-196" src="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-5.png" alt="" width="553" height="286" srcset="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-5.png 553w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-5-300x155.png 300w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-5-230x119.png 230w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-5-350x181.png 350w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-5-480x248.png 480w" sizes="(max-width: 553px) 85vw, 553px" />  
从官方的LoginAction类中可以看到notificationLogin方法  
他会接收notify参数的值赋值给encryptedEmailAddress,然后通过BrightmailDecrypt类下decrypt方法解密赋值给emailAddress,然后用emailAddress创建个UserTO对象，之后什么过滤“<>”创建username就不谈了，最后他会创建个session 这个session会有web管理界面的一些权限。

然而官方给的例子是  
<img class="alignnone size-full wp-image-197" src="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-6.png" alt="" width="554" height="224" srcset="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-6.png 554w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-6-300x121.png 300w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-6-230x93.png 230w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-6-350x142.png 350w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-6-480x194.png 480w" sizes="(max-width: 554px) 85vw, 554px" />  
<img class="alignnone size-full wp-image-198" src="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-7.png" alt="" width="554" height="377" srcset="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-7.png 554w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-7-300x204.png 300w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-7-230x157.png 230w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-7-350x238.png 350w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-7-480x327.png 480w" sizes="(max-width: 554px) 85vw, 554px" /> 

解密失败。。。 看来作者不想全部放出去啊。  
那么只能自己分析一波了

<img class="alignnone size-full wp-image-199" src="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-8.png" alt="" width="554" height="358" srcset="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-8.png 554w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-8-300x194.png 300w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-8-230x149.png 230w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-8-350x226.png 350w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-8-480x310.png 480w" sizes="(max-width: 554px) 85vw, 554px" />  
看解密的方法  
他会切割传进来的值前十二位为盐 12位到末尾为加密内容 之后会用到PBEWithMD5AndDES加密算法。而这个算法是对称加密的，那么这么看来就好办了，只要用他的加密方法生成一个加密串能被他解密就可以了。而他的加密方法在使用10.6.1的任意文件读取可以获得

<img class="alignnone size-full wp-image-200" src="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-9.png" alt="" width="554" height="193" srcset="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-9.png 554w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-9-300x105.png 300w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-9-550x193.png 550w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-9-230x80.png 230w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-9-350x122.png 350w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-9-480x167.png 480w" sizes="(max-width: 554px) 85vw, 554px" />  
好的成功了  
然后需要做的是  
获取一个token  
<img class="alignnone size-full wp-image-201" src="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-10.png" alt="" width="554" height="213" srcset="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-10.png 554w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-10-300x115.png 300w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-10-230x88.png 230w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-10-350x135.png 350w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-10-480x185.png 480w" sizes="(max-width: 554px) 85vw, 554px" />  
common.jsp会或缺一个symantec.brightmail.key.TOKEN  
<img class="alignnone size-full wp-image-202" src="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-11.png" alt="" width="773" height="358" srcset="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-11.png 773w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-11-300x139.png 300w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-11-768x356.png 768w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-11-230x107.png 230w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-11-350x162.png 350w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-11-480x222.png 480w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 984px) 61vw, (max-width: 1362px) 45vw, 600px" /> 

而在symantec封装的镜像中存在一个db-restore脚本  
该脚本存在调用/usr/bin/du命令注入。  
<img class="alignnone size-full wp-image-203" src="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-12.png" alt="" width="554" height="402" srcset="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-12.png 554w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-12-300x218.png 300w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-12-550x400.png 550w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-12-230x167.png 230w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-12-350x254.png 350w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-12-480x348.png 480w" sizes="(max-width: 554px) 85vw, 554px" />  
于是可以愉快的反弹shell了  
<img class="alignnone size-full wp-image-205" src="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-14.png" alt="" width="554" height="274" srcset="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-14.png 554w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-14-300x148.png 300w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-14-230x114.png 230w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-14-350x173.png 350w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-14-480x237.png 480w" sizes="(max-width: 554px) 85vw, 554px" />  
成功反弹shell

Exploit

个人对工具美化一向不感冒 直接 用官方的exp提示吧~~~print一下很简单  
<img class="alignnone size-full wp-image-206" src="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-15.png" alt="" width="554" height="185" srcset="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-15.png 554w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-15-300x100.png 300w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-15-550x185.png 550w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-15-230x77.png 230w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-15-350x117.png 350w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-15-480x160.png 480w" sizes="(max-width: 554px) 85vw, 554px" />  
<img class="alignnone size-full wp-image-207" src="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-16.png" alt="" width="554" height="217" srcset="http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-16.png 554w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-16-300x118.png 300w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-16-230x90.png 230w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-16-350x137.png 350w, http://www.cuijianxiong.top/wp-content/uploads/2018/01/1-16-480x188.png 480w" sizes="(max-width: 554px) 85vw, 554px" />